<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å­¸ç¿’æ­·ç¨‹ - THE PLANNER</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* ğŸ‰ ç¬¬ä¸€çœ¼ï¼šæˆå°±æ©«å¹… */
    .hero-banner {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 20px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .hero-icon {
      font-size: 80px;
      margin-bottom: 15px;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .hero-title {
      font-size: 32px;
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 10px;
    }

    .hero-subtitle {
      font-size: 18px;
      color: #4a5568;
      margin-bottom: 20px;
    }

    .hero-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      flex-wrap: wrap;
    }

    .hero-stat {
      text-align: center;
    }

    .hero-stat-value {
      font-size: 48px;
      font-weight: bold;
      color: #2d3748;
      display: block;
    }

    .hero-stat-label {
      font-size: 14px;
      color: #4a5568;
      margin-top: 5px;
    }

    /* ğŸ“Š ç¬¬äºŒçœ¼ï¼šé€²åº¦å¡ç‰‡ */
    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .card-icon {
      font-size: 32px;
    }

    .card-title {
      font-size: 24px;
      font-weight: bold;
      color: #2d3748;
    }

    /* é€²åº¦æ¢ */
    .progress-section {
      margin: 20px 0;
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
      color: #4a5568;
    }

    .progress-bar {
      height: 20px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      transition: width 1s ease-out;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: bold;
      font-size: 12px;
    }

    /* æŠ€èƒ½æ¨¹å°å¡ç‰‡ */
    .skill-badges {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 15px 0;
    }

    .skill-badge {
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .skill-completed {
      background: #d4edda;
      color: #155724;
    }

    .skill-progress {
      background: #fff3cd;
      color: #856404;
    }

    .skill-locked {
      background: #e2e8f0;
      color: #718096;
    }

    /* ğŸ’ª ç¬¬ä¸‰çœ¼ï¼šå¼·é …å±•ç¤º */
    .strength-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .strength-item {
      background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      padding: 20px;
      border-radius: 16px;
      text-align: center;
      border: 2px solid #28a745;
    }

    .strength-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .strength-title {
      font-size: 16px;
      font-weight: bold;
      color: #155724;
      margin-bottom: 5px;
    }

    .strength-desc {
      font-size: 13px;
      color: #155724;
      opacity: 0.8;
    }

    /* ğŸ“ ç¬¬å››çœ¼ï¼šæº«å’Œçš„å»ºè­° */
    .suggestion-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      border-left: 5px solid #2196f3;
    }

    .suggestion-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .suggestion-icon {
      font-size: 32px;
    }

    .suggestion-title {
      font-size: 18px;
      font-weight: bold;
      color: #1565c0;
    }

    .suggestion-content {
      font-size: 15px;
      color: #1565c0;
      line-height: 1.6;
    }

    .next-action {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-top: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .action-text {
      font-size: 15px;
      font-weight: 600;
      color: #2d3748;
    }

    .action-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.3s;
    }

    .action-btn:hover {
      transform: translateY(-2px);
    }

    /* ğŸ”¥ é€£çºŒå­¸ç¿’ */
    .streak-display {
      text-align: center;
      padding: 30px;
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border-radius: 16px;
      margin: 20px 0;
    }

    .streak-number {
      font-size: 72px;
      font-weight: bold;
      color: #ff6b6b;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .streak-label {
      font-size: 18px;
      color: #856404;
      margin-top: 10px;
    }

    .streak-calendar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .day-box {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      color: #999;
      transition: all 0.3s;
    }

    .day-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: scale(1.1);
    }

    .day-label {
      font-size: 9px;
      margin-top: 2px;
    }

    /* ğŸ“ˆ è©³ç´°æ•¸æ“š (å¯å±•é–‹) */
    .detail-toggle {
      text-align: center;
      margin: 30px 0;
    }

    .toggle-btn {
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
      padding: 12px 30px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      transition: all 0.3s;
    }

    .toggle-btn:hover {
      background: #667eea;
      color: white;
    }

    .detail-content {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }

    .detail-content.show {
      display: block;
    }

    /* è¿”å›æŒ‰éˆ• */
    .back-btn {
      background: white;
      color: #667eea;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }

    .back-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    @media (max-width: 768px) {
      .hero-stats { gap: 20px; }
      .hero-stat-value { font-size: 36px; }
      .hero-title { font-size: 24px; }
      .strength-grid { grid-template-columns: 1fr; }
    }

    /* è¼‰å…¥é®ç½© */
    .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
    }

    .loading-overlay.fade-out {
    opacity: 0;
    pointer-events: none;
    }

    .loading-spinner {
    width: 80px;
    height: 80px;
    border: 8px solid rgba(255, 255, 255, 0.2);
    border-top: 8px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    }

    @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
    }

    .loading-text {
    margin-top: 20px;
    color: white;
    font-size: 18px;
    font-weight: bold;
    animation: pulse-text 1.5s ease-in-out infinite;
    }

    @keyframes pulse-text {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
    }

    .loading-logo {
    width: 120px;
    height: 120px;
    margin-bottom: 30px;
    animation: float-logo 2s ease-in-out infinite;
    }

    @keyframes float-logo {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
    }

    /* ä½¿ç”¨è€…ä¸‹æ‹‰é¸å–® */
    .user-menu {
    position: relative;
    display: inline-block;
    }

    .user-display {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
    background: rgba(255, 255, 255, 0.1);
    }

    .user-display:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    }

    .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid white;
    }

    .user-info {
    color: white;
    text-align: left;
    }

    .user-name {
    font-weight: bold;
    font-size: 14px;
    display: block;
    }

    .user-stats {
    font-size: 11px;
    opacity: 0.85;
    display: block;
    }

    .dropdown-arrow {
    font-size: 12px;
    color: white;
    transition: transform 0.3s;
    }

    .user-menu.open .dropdown-arrow {
    transform: rotate(180deg);
    }

    .dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    min-width: 220px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
    }

    .user-menu.open .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    }

    .dropdown-item {
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.3s;
    border-bottom: 1px solid #f0f0f0;
    color: #333;
    text-decoration: none;
    }

    .dropdown-item:last-child {
    border-bottom: none;
    }

    .dropdown-item:hover {
    background: #f8f9fa;
    }

    .dropdown-icon {
    font-size: 20px;
    width: 24px;
    text-align: center;
    }

    .dropdown-text {
    flex: 1;
    }

    .dropdown-label {
    font-weight: 600;
    font-size: 14px;
    display: block;
    color: #2d3748;
    }

    .dropdown-desc {
    font-size: 11px;
    color: #718096;
    margin-top: 2px;
    }

    .dropdown-divider {
    height: 1px;
    background: #e2e8f0;
    margin: 8px 0;
    }

    .dropdown-item.logout {
    color: #e53e3e;
    }

    .dropdown-item.logout:hover {
    background: #fff5f5;
    }
  </style>
</head>
<body>
    <!-- è¼‰å…¥é®ç½© -->
    <div class="loading-overlay" id="loadingOverlay">
    <img src="assets/logo.png" alt="Logo" class="loading-logo" 
        onerror="this.style.display='none'">
    <div class="loading-spinner"></div>
    <div class="loading-text">è¼‰å…¥å­¸ç¿’åˆ†æä¸­...</div>
    </div>

    <!-- Header -->
    <header style="background: #4a6cf7; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1000;">
        <nav style="display: flex; gap: 8px; align-items: center;">
        <a href="index.html" style="display: flex; align-items: center; margin-right: 12px; text-decoration: none;">
            <img src="assets/logo.png" alt="Logo" style="height:40px; width:auto;" onerror="this.style.display='none'">
        </a>
        </nav>
        <div id="headerNav" style="display: flex; gap: 8px; align-items: center;">
        <!-- å‹•æ…‹è¼‰å…¥ -->
        </div>
    </header>

    <div class="container" style="padding-top: 88px;"></div>

  <div class="container">
    <!-- è¿”å›æŒ‰éˆ• -->
    <button class="back-btn" onclick="location.href='index.html'">â† è¿”å›é¦–é </button>

    <!-- ğŸ‰ ç¬¬ä¸€çœ¼ï¼šæˆå°±æ©«å¹… -->
    <div class="hero-banner">
      <div class="hero-icon">ğŸ†</div>
      <h1 class="hero-title" id="userName">è¼‰å…¥ä¸­...</h1>
      <p class="hero-subtitle">ä½ çš„å­¸ç¿’æ—…ç¨‹</p>
      <div class="hero-stats">
        <div class="hero-stat">
          <span class="hero-stat-value" id="totalSkills">0</span>
          <span class="hero-stat-label">å®ŒæˆæŠ€èƒ½</span>
        </div>
        <div class="hero-stat">
          <span class="hero-stat-value" id="totalTime">00:00:00</span>
          <span class="hero-stat-label">å­¸ç¿’æ™‚é–“</span>
        </div>
        <div class="hero-stat">
          <span class="hero-stat-value" id="avgScore">0%</span>
          <span class="hero-stat-label">å¹³å‡åˆ†æ•¸</span>
        </div>
      </div>
    </div>

    <!-- ğŸ“Š ç¬¬äºŒçœ¼ï¼šå­¸ç¿’é€²åº¦ -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">ğŸŒ³</span>
        <h2 class="card-title">æŠ€èƒ½æ¨¹é€²åº¦</h2>
      </div>
      
      <div class="skill-badges" id="skillBadges">
        <div class="skill-badge skill-completed">âœ“ è¼‰å…¥ä¸­...</div>
      </div>

      <div class="progress-section">
        <div class="progress-label">
          <span>æ•´é«”é€²åº¦</span>
          <span id="overallProgress">0%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="overallProgressBar" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- ğŸ”¥ é€£çºŒå­¸ç¿’ -->
    <div class="streak-display">
      <div class="streak-number" id="streakDays">0</div>
      <div class="streak-label">å¤©é€£çºŒå­¸ç¿’</div>
      <div class="streak-calendar" id="streakCalendar">
        <!-- å‹•æ…‹ç”Ÿæˆ -->
      </div>
    </div>

    <!-- ğŸ’ª ç¬¬ä¸‰çœ¼ï¼šä½ çš„å¼·é … -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">ğŸ’ª</span>
        <h2 class="card-title">ä½ çš„å¼·é …</h2>
      </div>
      
      <div class="strength-grid" id="strengthGrid">
        <div class="strength-item">
          <div class="strength-icon">âš¡</div>
          <div class="strength-title">å¿«é€Ÿå­¸ç¿’</div>
          <div class="strength-desc">å¹³å‡å®Œæˆé€Ÿåº¦æ¯”å…¶ä»–å­¸ç¿’è€…å¿« 20%</div>
        </div>
      </div>
    </div>

    <!-- ğŸ“ ç¬¬å››çœ¼ï¼šçµ¦ä½ çš„å»ºè­° -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">ğŸ’¡</span>
        <h2 class="card-title">çµ¦ä½ çš„å»ºè­°</h2>
      </div>

      <div class="suggestion-box">
        <div class="suggestion-header">
          <span class="suggestion-icon">ğŸ¯</span>
          <span class="suggestion-title">ä¸‹ä¸€æ­¥å»ºè­°</span>
        </div>
        <div class="suggestion-content" id="suggestionContent">
          è¼‰å…¥ä¸­...
        </div>
        <div class="next-action">
          <span class="action-text">æº–å‚™å¥½æŒ‘æˆ°ä¸‹ä¸€é—œäº†å—ï¼Ÿ</span>
          <button class="action-btn" onclick="location.href='learning.html?project=appinventor'">
            é–‹å§‹å­¸ç¿’ â†’
          </button>
        </div>
      </div>
    </div>

    <!-- ğŸ“ˆ è©³ç´°æ•¸æ“š (å¯é¸) -->
    <div class="detail-toggle">
      <button class="toggle-btn" onclick="toggleDetail()">
        ğŸ“Š æŸ¥çœ‹è©³ç´°å­¸ç¿’æ•¸æ“š
      </button>
    </div>

    <div class="detail-content" id="detailContent">
      <div class="card">
        <div class="card-header">
          <span class="card-icon">ğŸ“¹</span>
          <h2 class="card-title">å½±ç‰‡è§€çœ‹ç´€éŒ„</h2>
        </div>
        <div id="videoDetails">è¼‰å…¥ä¸­...</div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-icon">ğŸ“</span>
          <h2 class="card-title">æ¸¬é©—è¡¨ç¾ç´€éŒ„</h2>
        </div>
        <div id="quizDetails">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIpzh9pK2QSmsGnyLWqlHuVPjykKgoWgEjrw6CNuMOcxctN0bdg6cJzSi1ecnr63Il/exec';
    
    let currentUser = null;
    let detailVisible = false;

    // JSONP è«‹æ±‚
    function makeRequest(data) {
    return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
        
        // ğŸ”¥ å…ˆå®šç¾©å…¨åŸŸå›èª¿å‡½æ•¸
        window[callbackName] = function(response) {
        console.log('ğŸ“¥ API å›æ‡‰:', response);
        delete window[callbackName];
        if (script && script.parentNode) {
            script.parentNode.removeChild(script);
        }
        resolve(response);
        };
        
        const params = new URLSearchParams({ 
        callback: callbackName, 
        ...data 
        });
        
        const script = document.createElement('script');
        script.src = `${SCRIPT_URL}?${params}`;
        
        // ğŸ”¥ éŒ¯èª¤è™•ç†
        script.onerror = () => {
        console.error('âŒ JSONP è¼‰å…¥å¤±æ•—');
        delete window[callbackName];
        if (script && script.parentNode) {
            script.parentNode.removeChild(script);
        }
        reject(new Error('è«‹æ±‚å¤±æ•—'));
        };
        
        // ğŸ”¥ è¶…æ™‚è™•ç†
        setTimeout(() => {
        if (window[callbackName]) {
            console.error('â±ï¸ JSONP è«‹æ±‚è¶…æ™‚');
            delete window[callbackName];
            if (script && script.parentNode) {
            script.parentNode.removeChild(script);
            }
            reject(new Error('è«‹æ±‚è¶…æ™‚'));
        }
        }, 15000);
        
        // ğŸ”¥ æœ€å¾Œæ‰åŠ å…¥ scriptï¼ˆç¢ºä¿å›èª¿å‡½æ•¸å·²å®šç¾©ï¼‰
        document.body.appendChild(script);
    });
    }

    // è¼‰å…¥æ•¸æ“š
    async function loadDashboard() {
      const userData = localStorage.getItem('currentUser');
      if (!userData) {
        alert('è«‹å…ˆç™»å…¥');
        location.href = 'login.html';
        return;
      }

      currentUser = JSON.parse(userData);
      updateHeaderUI();
      document.getElementById('userName').textContent = `${currentUser.displayName} çš„å­¸ç¿’æˆæœ`;

      try {
        // è¼‰å…¥çµ±è¨ˆ
        const stats = await makeRequest({
          action: 'getUserStats',
          userId: currentUser.userId
        });

        if (stats.success) {
          document.getElementById('totalSkills').textContent = stats.data.completedCourses || 0;
          document.getElementById('totalTime').textContent = stats.data.totalTime || '00:00:00';
          document.getElementById('avgScore').textContent = '87%'; // ç¤ºä¾‹
          document.getElementById('overallProgress').textContent = 
            Math.round((stats.data.completedCourses / 20) * 100) + '%';
          document.getElementById('overallProgressBar').style.width = 
            Math.round((stats.data.completedCourses / 20) * 100) + '%';
        }

        // è¼‰å…¥æŠ€èƒ½é€²åº¦
        const progress = await makeRequest({
          action: 'getUserProgress',
          userId: currentUser.userId,
          courseId: 'appinventor'
        });

        if (progress.success) {
          displaySkillBadges(progress.data.completedSkills || []);
        }

        // ç”Ÿæˆå»ºè­°
        generateSuggestion(stats.data);

        // è¼‰å…¥è©³ç´°æ•¸æ“š
        await loadDetailedData();

        } catch (err) {
            console.error('è¼‰å…¥å¤±æ•—:', err);
        } finally {
            // ğŸ”¥ ç§»é™¤è¼‰å…¥ç•«é¢
            setTimeout(() => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.classList.add('fade-out');
                setTimeout(() => loadingOverlay.remove(), 500);
            }
            }, 500);
        }
    }

    // é¡¯ç¤ºæŠ€èƒ½å¾½ç« ï¼ˆå‹•æ…‹å¾èª²ç¨‹é…ç½®è®€å–ï¼‰
    async function displaySkillBadges(completedSkillIds) {
    const badges = document.getElementById('skillBadges');
    badges.innerHTML = '<div class="skill-badge skill-completed">âœ“ è¼‰å…¥ä¸­...</div>';
    
    try {
        // ğŸ”¥ å¾å¾Œç«¯è®€å–èª²ç¨‹é…ç½®
        const configData = await makeRequest({
        action: 'getCourseConfig',
        courseId: 'appinventor'
        });
        
        if (!configData.success) {
        badges.innerHTML = '<div class="skill-badge skill-locked">è¼‰å…¥å¤±æ•—</div>';
        return;
        }
        
        const skills = configData.data.skills;
        
        // ğŸ”¥ æŒ‰æŠ€èƒ½IDæ’åº
        const sortedSkills = Object.values(skills).sort((a, b) => a.id - b.id);
        
        // ğŸ”¥ åªé¡¯ç¤ºå‰8å€‹æŠ€èƒ½ï¼ˆé¿å…å¤ªé•·ï¼‰
        const displaySkills = sortedSkills.slice(0, 8);
        
        badges.innerHTML = displaySkills.map(skill => {
        const isCompleted = completedSkillIds.includes(skill.id);
        const className = isCompleted ? 'skill-completed' : 'skill-locked';
        const icon = isCompleted ? 'âœ“' : 'ğŸ”’';
        return `<div class="skill-badge ${className}">${icon} ${skill.name}</div>`;
        }).join('');
        
        // ğŸ”¥ å¦‚æœé‚„æœ‰æ›´å¤šæŠ€èƒ½ï¼Œé¡¯ç¤ºæç¤º
        if (sortedSkills.length > 8) {
        badges.innerHTML += `<div class="skill-badge skill-progress">... é‚„æœ‰ ${sortedSkills.length - 8} å€‹æŠ€èƒ½</div>`;
        }
        
    } catch (err) {
        console.error('è¼‰å…¥æŠ€èƒ½å¤±æ•—:', err);
        badges.innerHTML = '<div class="skill-badge skill-locked">è¼‰å…¥å¤±æ•—</div>';
    }
    }

    // ç”Ÿæˆå»ºè­°ï¼ˆé è¨­è¦å‰‡ï¼‰
    function generateSuggestion(stats) {
    const suggestions = document.getElementById('suggestionContent');
    const completed = stats.completedCourses || 0;
    
    // ğŸ”¥ å¤šç¨®å»ºè­°æ¨¡æ¿
    const templates = {
        beginner: [
        'æ­¡è¿é–‹å§‹ä½ çš„ç¬¬ä¸€å€‹æŠ€èƒ½ï¼å»ºè­°å¾ã€ŒåŸºç¤ä»‹ç´¹ã€é–‹å§‹ï¼Œé€™æœƒå¹«åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹ã€‚',
        'å‰›é–‹å§‹å­¸ç¿’æ˜¯æœ€èˆˆå¥®çš„æ™‚åˆ»ï¼å»ºè­°å…ˆå®ŒæˆåŸºç¤èª²ç¨‹ï¼Œæ‰“å¥½åŸºç¤ã€‚',
        'æ–°æ‰‹ä¸Šè·¯ï¼å…ˆå¾ç°¡å–®çš„èª²ç¨‹é–‹å§‹ï¼Œæ…¢æ…¢å»ºç«‹ä¿¡å¿ƒå§ï¼'
        ],
        intermediate: [
        `ä½ å·²ç¶“å®Œæˆ ${completed} å€‹æŠ€èƒ½äº†ï¼ç¹¼çºŒä¿æŒé€™å€‹ç¯€å¥ï¼Œå¾ˆå¿«å°±èƒ½è§£é–æ›´å¤šæœ‰è¶£çš„å…§å®¹ã€‚`,
        `é€²æ­¥ç¥é€Ÿï¼${completed} å€‹æŠ€èƒ½å·²ç¶“å®Œæˆï¼Œå»ºè­°æŒ‘æˆ°æ›´é€²éšçš„å…§å®¹ã€‚`,
        `åšå¾—å¾ˆå¥½ï¼å·²ç¶“å®Œæˆ ${completed} å€‹æŠ€èƒ½ï¼Œè·é›¢ç›®æ¨™è¶Šä¾†è¶Šè¿‘äº†ï¼`
        ],
        advanced: [
        'ä½ å·²ç¶“æ˜¯é«˜æ‰‹äº†ï¼æº–å‚™æŒ‘æˆ°æœ€å¾Œçš„å°ˆé¡Œç™¼è¡¨ï¼Œå±•ç¤ºä½ çš„å­¸ç¿’æˆæœå§ï¼',
        'å¤ªå²å®³äº†ï¼å¤§éƒ¨åˆ†æŠ€èƒ½éƒ½å·²å®Œæˆï¼Œç¾åœ¨å¯ä»¥é–‹å§‹åšå°ˆé¡Œäº†ï¼',
        'æ­å–œä½ å³å°‡å®Œæˆæ‰€æœ‰èª²ç¨‹ï¼æœ€å¾Œä¸€å“©è·¯ï¼ŒåŠ æ²¹ï¼'
        ]
    };
    
    // ğŸ”¥ æ ¹æ“šé€²åº¦é¸æ“‡å»ºè­°
    let category, index;
    if (completed === 0) {
        category = 'beginner';
    } else if (completed < 10) {
        category = 'intermediate';
    } else {
        category = 'advanced';
    }
    
    // ğŸ”¥ éš¨æ©Ÿé¸æ“‡ä¸€å€‹å»ºè­°ï¼ˆå¢åŠ è®ŠåŒ–æ€§ï¼‰
    index = Math.floor(Math.random() * templates[category].length);
    suggestions.textContent = templates[category][index];
    }

    // åˆ‡æ›è©³ç´°æ•¸æ“š
    function toggleDetail() {
      detailVisible = !detailVisible;
      document.getElementById('detailContent').classList.toggle('show');
      document.querySelector('.toggle-btn').textContent = 
        detailVisible ? 'ğŸ“Š éš±è—è©³ç´°æ•¸æ“š' : 'ğŸ“Š æŸ¥çœ‹è©³ç´°å­¸ç¿’æ•¸æ“š';
    }

    // è¼‰å…¥è©³ç´°æ•¸æ“š
    async function loadDetailedData() {
    try {
        // ğŸ”¥ è¼‰å…¥å½±ç‰‡è¨˜éŒ„
        const videoData = await makeRequest({
        action: 'getVideoRecords',
        userId: currentUser.userId
        });
        
        displayVideoDetails(videoData);
        
        // ğŸ”¥ è¼‰å…¥æ¸¬é©—è¨˜éŒ„
        const quizData = await makeRequest({
        action: 'getQuizRecords',
        userId: currentUser.userId
        });
        
        displayQuizDetails(quizData);
        
    } catch (err) {
        console.error('è¼‰å…¥è©³ç´°æ•¸æ“šå¤±æ•—:', err);
    }
    }

    // é¡¯ç¤ºå½±ç‰‡è¨˜éŒ„
    function displayVideoDetails(data) {
    const container = document.getElementById('videoDetails');
    
    if (!data || !data.success || !data.records || data.records.length === 0) {
        container.innerHTML = `
        <div style="text-align: center; padding: 30px; color: #999;">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“¹</div>
            <div>é‚„æ²’æœ‰è§€çœ‹è¨˜éŒ„</div>
        </div>
        `;
        return;
    }
    
    // ğŸ”¥ é¡¯ç¤ºæœ€è¿‘5ç­†è¨˜éŒ„
    const recentRecords = data.records.slice(0, 5);
    
    container.innerHTML = recentRecords.map(record => `
        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span style="font-weight: bold; color: #2d3748;">${record.skillName || 'æœªçŸ¥èª²ç¨‹'}</span>
            <span style="color: #10b981; font-weight: bold;">${record.completionRate || 100}%</span>
        </div>
        <div style="font-size: 12px; color: #718096;">
            è§€çœ‹æ™‚é–“ï¼š${record.watchDate || 'æœªçŸ¥'}
        </div>
        </div>
    `).join('');
    }

    // é¡¯ç¤ºæ¸¬é©—è¨˜éŒ„
    function displayQuizDetails(data) {
    const container = document.getElementById('quizDetails');
    
    if (!data || !data.success || !data.records || data.records.length === 0) {
        container.innerHTML = `
        <div style="text-align: center; padding: 30px; color: #999;">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
            <div>é‚„æ²’æœ‰æ¸¬é©—è¨˜éŒ„</div>
        </div>
        `;
        return;
    }
    
    // ğŸ”¥ é¡¯ç¤ºæœ€è¿‘5ç­†è¨˜éŒ„
    const recentRecords = data.records.slice(0, 5);
    
    container.innerHTML = recentRecords.map(record => `
        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span style="font-weight: bold; color: #2d3748;">${record.skillName || 'æœªçŸ¥æ¸¬é©—'}</span>
            <span style="color: ${record.score >= 80 ? '#10b981' : '#f59e0b'}; font-weight: bold;">
            ${record.score || 0} åˆ†
            </span>
        </div>
        <div style="font-size: 12px; color: #718096;">
            æ¸¬é©—æ™‚é–“ï¼š${record.quizDate || 'æœªçŸ¥'} | å˜—è©¦æ¬¡æ•¸ï¼š${record.attemptNumber || 1}
        </div>
        </div>
    `).join('');
    }

    // é é¢è¼‰å…¥
    window.onload = loadDashboard;

    // æ›´æ–° Header UI
    function updateHeaderUI() {
    if (!currentUser) return;
    
    const navRight = document.getElementById('headerNav');
    navRight.innerHTML = `
        <div class="user-menu" id="userMenu">
        <div class="user-display" onclick="toggleUserMenu()">
            <img src="${currentUser.avatar}" alt="avatar" class="user-avatar">
            <div class="user-info">
            <span class="user-name">${currentUser.displayName}</span>
            <span class="user-stats">å®Œæˆ ${currentUser.completedCourses || 0} èª²ç¨‹</span>
            </div>
            <span class="dropdown-arrow">â–¼</span>
        </div>
        
        <div class="dropdown-menu">
            <a href="dashboard.html" class="dropdown-item">
            <span class="dropdown-icon">ğŸ“Š</span>
            <div class="dropdown-text">
                <span class="dropdown-label">å­¸ç¿’åˆ†æ</span>
                <span class="dropdown-desc">æŸ¥çœ‹å­¸ç¿’é€²åº¦èˆ‡çµ±è¨ˆ</span>
            </div>
            </a>
            
            <a href="achievements.html" class="dropdown-item">
            <span class="dropdown-icon">ğŸ†</span>
            <div class="dropdown-text">
                <span class="dropdown-label">æˆå°±ç³»çµ±</span>
                <span class="dropdown-desc">æŸ¥çœ‹ç²å¾—çš„æˆå°±èˆ‡å¾½ç« </span>
            </div>
            </a>
            
            <div class="dropdown-divider"></div>
            
            <div class="dropdown-item logout" onclick="logout()">
            <span class="dropdown-icon">ğŸšª</span>
            <div class="dropdown-text">
                <span class="dropdown-label">ç™»å‡º</span>
            </div>
            </div>
        </div>
        </div>
    `;
    }

    // åˆ‡æ›é¸å–®
    function toggleUserMenu() {
    const menu = document.getElementById('userMenu');
    menu.classList.toggle('open');
    }

    // é»æ“Šå¤–éƒ¨é—œé–‰
    document.addEventListener('click', function(event) {
    const menu = document.getElementById('userMenu');
    if (menu && !menu.contains(event.target)) {
        menu.classList.remove('open');
    }
    });

    // ç™»å‡º
    function logout() {
    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—?')) {
        localStorage.removeItem('currentUser');
        location.href = 'index.html';
    }
    }
  </script>
</body>
</html>