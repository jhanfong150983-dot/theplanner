<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç™»å…¥ - THE PLANNER å­¸ç¿’ç¶²</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    /* èƒŒæ™¯è£é£¾ */
    body::before {
      content: '';
      position: absolute;
      width: 500px;
      height: 500px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      top: -200px;
      right: -200px;
      animation: float 6s ease-in-out infinite;
    }

    body::after {
      content: '';
      position: absolute;
      width: 300px;
      height: 300px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 50%;
      bottom: -150px;
      left: -150px;
      animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    .login-container {
      background: white;
      border-radius: 30px;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.3);
      max-width: 420px;
      width: 100%;
      padding: 60px 40px;
      text-align: center;
      animation: slideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      z-index: 1;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* å‰ç¥¥ç‰©å€åŸŸ */
    .mascot-container {
      width: 140px;
      height: 140px;
      margin: 0 auto 30px;
      position: relative;
    }

    .mascot {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 70px;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      animation: bounce 2s ease-in-out infinite;
      position: relative;
    }

    .mascot::before {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 3px solid rgba(102, 126, 234, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.15); opacity: 0; }
    }

    .login-title {
      font-size: 32px;
      font-weight: 700;
      color: #333;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .login-subtitle {
      font-size: 16px;
      color: #888;
      margin-bottom: 40px;
      line-height: 1.5;
    }

    .google-login-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      min-height: 50px;
    }

    .quick-info {
      background: linear-gradient(135deg, #f5f7ff 0%, #fef5ff 100%);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .info-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #666;
      font-size: 14px;
      margin: 8px 0;
    }

    .info-icon {
      font-size: 18px;
    }

    .back-link {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .back-link:hover {
      color: #764ba2;
      transform: translateX(-3px);
    }

    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading.active {
      display: flex;
    }

    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #333;
      font-size: 16px;
      font-weight: 600;
    }

    .error-message {
      display: none;
      background: #fee;
      border-left: 4px solid #f44;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 14px;
      text-align: left;
    }

    .error-message.active {
      display: block;
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* éŸ¿æ‡‰å¼ */
    @media (max-width: 480px) {
      .login-container {
        padding: 50px 30px;
      }
      .login-title {
        font-size: 28px;
      }
      .mascot-container {
        width: 120px;
        height: 120px;
      }
      .mascot {
        font-size: 60px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <!-- å‰ç¥¥ç‰© -->
    <div class="mascot-container">
      <div class="mascot">
        <img src="assets/mascot.png" alt="PBL å‰ç¥¥ç‰©" style="width: 80%; height: 80%; object-fit: contain;" onerror="this.parentElement.innerHTML='ğŸ“'">
      </div>
    </div>
    
    <!-- æ¨™é¡Œ -->
    <h1 class="login-title">é–‹å§‹ä½ çš„å­¸ç¿’ä¹‹æ—…</h1>
    <p class="login-subtitle">ä½¿ç”¨ Google å¸³è™Ÿå³å¯å¿«é€Ÿç™»å…¥/è¨»å†Š</p>
    
    <!-- Google ç™»å…¥æŒ‰éˆ• -->
    <div class="google-login-wrapper">
      <div id="g_id_onload"
           data-client_id="337555990444-q69o7nufa9rmumi33nsggdcump0su9hb.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <div id="google-button"></div>
    </div>
    
    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div class="error-message" id="errorMessage"></div>
    
    <!-- å¿«é€Ÿèªªæ˜ -->
    <div class="quick-info">
      <div class="info-item">
        <span class="info-icon">âœ¨</span>
        <span>é¦–æ¬¡ç™»å…¥è‡ªå‹•å®Œæˆè¨»å†Š</span>
      </div>
      <div class="info-item">
        <span class="info-icon">ğŸ”’</span>
        <span>å®‰å…¨å¿«é€Ÿ,ç„¡éœ€è¨˜æ†¶å¯†ç¢¼</span>
      </div>
    </div>
    
    <!-- è¿”å›é¦–é  -->
    <a href="index.html" class="back-link">
      <span>â†</span>
      <span>è¿”å›é¦–é </span>
    </a>
  </div>

  <!-- è¼‰å…¥ç‹€æ…‹ -->
  <div class="loading" id="loadingState">
    <div class="loading-content">
      <div class="spinner"></div>
      <p class="loading-text">æ­£åœ¨ç™»å…¥ä¸­...</p>
    </div>
  </div>

  <script>
    // ============================================
    // ğŸ”¥ é‡è¦:è«‹æ›´æ–°ç‚ºä½ æœ€æ–°éƒ¨ç½²çš„ Apps Script ç¶²å€
    // ============================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVfnpHt8ctOrolr0z3gR7hKxQoyNRDUKVC00w0GnpLniNltIwxDOdlPI10UaASt2Zu/exec';
    
    console.log('ğŸ”— ä½¿ç”¨çš„ API ç¶²å€:', SCRIPT_URL);
    
    // ============================================
    // ğŸ“Œ é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    // ============================================
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.add('active');
      setTimeout(() => {
        errorDiv.classList.remove('active');
      }, 5000);
    }
    
    // ============================================
    // ğŸ“Œ è§£æ JWT Token
    // ============================================
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error('âŒ JWT è§£æå¤±æ•—:', e);
        return null;
      }
    }
    
    // ============================================
    // ğŸ“Œ JSONP è«‹æ±‚å‡½æ•¸
    // ============================================
    function makeRequest(data) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_' + Date.now() + '_' + Math.floor(Math.random() * 100000);
        
        window[callbackName] = function(response) {
          console.log('ğŸ“¥ JSONP å›æ‡‰:', response);
          delete window[callbackName];
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
          resolve(response);
        };
        
        const params = new URLSearchParams({
          callback: callbackName,
          ...data
        });
        
        const script = document.createElement('script');
        script.src = `${SCRIPT_URL}?${params.toString()}`;
        script.onerror = (error) => {
          console.error('âŒ JSONP è¼‰å…¥å¤±æ•—:', error);
          delete window[callbackName];
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
          reject(new Error('è«‹æ±‚å¤±æ•—'));
        };
        
        document.body.appendChild(script);
        
        setTimeout(() => {
          if (window[callbackName]) {
            console.error('â±ï¸ JSONP è«‹æ±‚è¶…æ™‚');
            delete window[callbackName];
            if (script && script.parentNode) {
              script.parentNode.removeChild(script);
            }
            reject(new Error('è«‹æ±‚è¶…æ™‚,è«‹ç¨å¾Œå†è©¦'));
          }
        }, 15000);
      });
    }
    
    // ============================================
    // ğŸ“Œ Google ç™»å…¥å›èª¿å‡½æ•¸
    // ============================================
    async function handleCredentialResponse(response) {
      console.log('ğŸ” æ”¶åˆ° Google ç™»å…¥å›æ‡‰');
      
      document.getElementById('loadingState').classList.add('active');
      
      try {
        const userInfo = parseJwt(response.credential);
        
        if (!userInfo) {
          showError('ç™»å…¥å¤±æ•—,è«‹é‡è©¦');
          document.getElementById('loadingState').classList.remove('active');
          return;
        }
        
        const email = userInfo.email;
        const name = userInfo.name;
        const avatar = userInfo.picture;
        
        console.log('âœ… Google ç™»å…¥æˆåŠŸ:', { email, name });
        
        // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å­˜åœ¨
        console.log('ğŸ” æª¢æŸ¥ä½¿ç”¨è€…...');
        const checkData = await makeRequest({
          action: 'checkUser',
          email: email
        });
        console.log('ğŸ“‹ æª¢æŸ¥çµæœ:', checkData);
        
        if (checkData.success && checkData.data && checkData.data.exists) {
          // âœ… å·²è¨»å†Šä½¿ç”¨è€… - ç›´æ¥ç™»å…¥
          console.log('ğŸ‘¤ ä½¿ç”¨è€…å·²å­˜åœ¨,æº–å‚™ç™»å…¥...');
          const userData = {
            userId: checkData.data.userId,
            email: email,
            displayName: checkData.data.displayName,
            avatar: checkData.data.avatar,
            completedCourses: checkData.data.completedCourses || 0,
            totalHours: checkData.data.totalHours || 0
          };
          
          localStorage.setItem('currentUser', JSON.stringify(userData));
          
          alert(`æ­¡è¿å›ä¾†,${userData.displayName}!`);
          window.location.href = 'index.html';
          
        } else {
          // âœ¨ æ–°ä½¿ç”¨è€… - è¨»å†Š
          console.log('ğŸ“ æ–°ä½¿ç”¨è€…,é–‹å§‹è¨»å†Š...');
          const registerData = await makeRequest({
            action: 'registerUser',
            email: email,
            name: name,
            displayName: name,
            avatar: avatar
          });
          console.log('ğŸ“‹ è¨»å†Šçµæœ:', registerData);
          
          if (registerData.success) {
            const userData = {
              userId: registerData.userId,
              email: email,
              displayName: name,
              avatar: avatar,
              completedCourses: 0,
              totalHours: 0
            };
            
            localStorage.setItem('currentUser', JSON.stringify(userData));
            
            alert(`ğŸ‰ æ­¡è¿åŠ å…¥ PBL è‡ªä¸»å­¸ç¿’å¹³å°,${name}!`);
            window.location.href = 'index.html';
          } else {
            showError('è¨»å†Šå¤±æ•—: ' + (registerData.message || 'è«‹ç¨å¾Œå†è©¦'));
          }
        }
        
      } catch (error) {
        console.error('âŒ ç™»å…¥è™•ç†å¤±æ•—:', error);
        showError('ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      } finally {
        document.getElementById('loadingState').classList.remove('active');
      }
    }
    
    // ============================================
    // ğŸ“Œ é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    // ============================================
    window.onload = function() {
      console.log('ğŸ”„ é é¢è¼‰å…¥å®Œæˆ,åˆå§‹åŒ– Google ç™»å…¥...');
      
      // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      const currentUser = localStorage.getItem('currentUser');
      if (currentUser) {
        try {
          const user = JSON.parse(currentUser);
          if (confirm(`æ‚¨å·²ç™»å…¥ç‚º ${user.displayName},è¦ç¹¼çºŒä½¿ç”¨å—?`)) {
            window.location.href = 'index.html';
            return;
          } else {
            localStorage.removeItem('currentUser');
          }
        } catch (e) {
          localStorage.removeItem('currentUser');
        }
      }
      
      // ç­‰å¾… Google API è¼‰å…¥
      if (typeof google !== 'undefined' && google.accounts) {
        initializeGoogleLogin();
      } else {
        setTimeout(() => {
          if (typeof google !== 'undefined' && google.accounts) {
            initializeGoogleLogin();
          } else {
            showError('Google ç™»å…¥æœå‹™è¼‰å…¥å¤±æ•—,è«‹é‡æ–°æ•´ç†é é¢');
          }
        }, 1000);
      }
    };
    
    // ============================================
    // ğŸ“Œ åˆå§‹åŒ– Google ç™»å…¥
    // ============================================
    function initializeGoogleLogin() {
      try {
        google.accounts.id.initialize({
          client_id: '337555990444-q69o7nufa9rmumi33nsggdcump0su9hb.apps.googleusercontent.com',
          callback: handleCredentialResponse,
          auto_select: false
        });
        
        google.accounts.id.renderButton(
          document.getElementById('google-button'),
          { 
            theme: 'outline', 
            size: 'large',
            text: 'signin_with',
            locale: 'zh_TW',
            width: 280
          }
        );
        
        console.log('âœ… Google ç™»å…¥æŒ‰éˆ•å·²æ¸²æŸ“');
      } catch (error) {
        console.error('âŒ åˆå§‹åŒ– Google ç™»å…¥å¤±æ•—:', error);
        showError('åˆå§‹åŒ–ç™»å…¥æœå‹™å¤±æ•—: ' + error.message);
      }
    }
  </script>
</body>
</html>