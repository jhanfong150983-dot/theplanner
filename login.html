<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç™»å…¥ - PBL è‡ªä¸»å­¸ç¿’å¹³å°</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 450px;
      width: 100%;
      padding: 50px 40px;
      text-align: center;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .login-title {
      font-size: 32px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .login-subtitle {
      font-size: 16px;
      color: #666;
      margin-bottom: 40px;
    }

    .google-login-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
      min-height: 50px;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 30px 0;
      color: #999;
      font-size: 14px;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e0e0e0;
    }

    .divider::before {
      margin-right: 10px;
    }

    .divider::after {
      margin-left: 10px;
    }

    .features {
      text-align: left;
      margin-bottom: 30px;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
      color: #666;
      font-size: 14px;
    }

    .feature-icon {
      width: 24px;
      height: 24px;
      background: #f0f4ff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .back-link {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s;
      display: inline-block;
      margin-top: 20px;
    }

    .back-link:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    .loading {
      display: none;
      margin-top: 20px;
      color: #666;
      font-size: 14px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      display: none;
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-top: 20px;
      font-size: 14px;
    }

    .error-message.active {
      display: block;
    }

    @media (max-width: 480px) {
      .login-container {
        padding: 40px 30px;
      }
      .login-title {
        font-size: 26px;
      }
    }
  </style>
</head>
<body>
  <div class="login-container">
    <!-- Logo -->
    <div class="logo">ğŸ“</div>
    
    <!-- æ¨™é¡Œ -->
    <h1 class="login-title">æ­¡è¿å›ä¾†!</h1>
    <p class="login-subtitle">ä½¿ç”¨ Google å¸³è™Ÿå¿«é€Ÿç™»å…¥</p>
    
    <!-- Google ç™»å…¥æŒ‰éˆ•å®¹å™¨ (ä¿®æ­£) -->
    <div class="google-login-wrapper">
      <!-- Google è‡ªå‹•è¼‰å…¥é…ç½® -->
      <div id="g_id_onload"
           data-client_id="337555990444-q69o7nufa9rmumi33nsggdcump0su9hb.apps.googleusercontent.com"
           data-callback="handleCredentialResponse"
           data-auto_prompt="false">
      </div>
      <!-- å¯¦éš›æŒ‰éˆ•æ¸²æŸ“ä½ç½® -->
      <div id="google-button"></div>
    </div>
    
    <!-- éŒ¯èª¤è¨Šæ¯ -->
    <div class="error-message" id="errorMessage"></div>
    
    <!-- åˆ†éš”ç·š -->
    <div class="divider">æˆ–</div>
    
    <!-- å¹³å°ç‰¹è‰² -->
    <div class="features">
      <div class="feature-item">
        <div class="feature-icon">ğŸ®</div>
        <span>éŠæˆ²åŒ–å­¸ç¿’é«”é©—</span>
      </div>
      <div class="feature-item">
        <div class="feature-icon">ğŸ“Š</div>
        <span>å³æ™‚è¿½è¹¤å­¸ç¿’é€²åº¦</span>
      </div>
      <div class="feature-item">
        <div class="feature-icon">ğŸ†</div>
        <span>è§£é–æˆå°±èˆ‡å¾½ç« </span>
      </div>
    </div>
    
    <!-- è¿”å›é¦–é  -->
    <a href="index.html" class="back-link">â† è¿”å›é¦–é </a>
    
    <!-- è¼‰å…¥ç‹€æ…‹ -->
    <div class="loading" id="loadingState">
      <div class="spinner"></div>
      <p>ç™»å…¥ä¸­...</p>
    </div>
  </div>

  <script>
    // Google Apps Script API ç¶²å€
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAQ3VMxGxTq2hAy9UkyUX0jlQuW9wgPIOIwbkb8pQfLsNxHj9XVbduF9PWB3IMijXn/exec';
    
    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.add('active');
      setTimeout(() => {
        errorDiv.classList.remove('active');
      }, 5000);
    }
    
    // è§£æ JWT Token
    function parseJwt(token) {
      try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => 
          '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join(''));
        return JSON.parse(jsonPayload);
      } catch (e) {
        console.error('JWT è§£æå¤±æ•—:', e);
        return null;
      }
    }
    
    // Google ç™»å…¥å›èª¿å‡½æ•¸
    async function handleCredentialResponse(response) {
      console.log('æ”¶åˆ° Google ç™»å…¥å›æ‡‰');
      
      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      document.getElementById('loadingState').classList.add('active');
      
      try {
        // è§£æä½¿ç”¨è€…è³‡è¨Š
        const userInfo = parseJwt(response.credential);
        
        if (!userInfo) {
          showError('ç™»å…¥å¤±æ•—,è«‹é‡è©¦');
          document.getElementById('loadingState').classList.remove('active');
          return;
        }
        
        const email = userInfo.email;
        const name = userInfo.name;
        const avatar = userInfo.picture;
        
        console.log('Google ç™»å…¥æˆåŠŸ:', { email, name });
        
        // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²è¨»å†Š
        const checkResponse = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            action: 'checkUser',
            email: email
          })
        });
        
        const checkData = await checkResponse.json();
        console.log('æª¢æŸ¥ä½¿ç”¨è€…å›æ‡‰:', checkData);
        
        if (checkData.data && checkData.data.exists) {
          // å·²è¨»å†Šä½¿ç”¨è€…
          const userData = {
            userId: checkData.data.userId,
            email: email,
            displayName: checkData.data.displayName,
            avatar: checkData.data.avatar,
            completedCourses: checkData.data.completedCourses || 0,
            totalHours: checkData.data.totalHours || 0
          };
          
          // å„²å­˜åˆ° localStorage
          localStorage.setItem('currentUser', JSON.stringify(userData));
          
          // è·³è½‰åˆ°é¦–é 
          alert(`æ­¡è¿å›ä¾†,${userData.displayName}!`);
          window.location.href = 'index.html';
          
        } else {
          // æ–°ä½¿ç”¨è€…,è¨»å†Š
          console.log('æ–°ä½¿ç”¨è€…,é–‹å§‹è¨»å†Š...');
          const registerResponse = await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'cors',
            headers: { 
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              action: 'registerUser',
              email: email,
              name: name,
              avatar: avatar
            })
          });
          
          const registerData = await registerResponse.json();
          console.log('è¨»å†Šå›æ‡‰:', registerData);
          
          if (registerData.success) {
            const userData = {
              userId: registerData.userId,
              email: email,
              displayName: name,
              avatar: avatar,
              completedCourses: 0,
              totalHours: 0
            };
            
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('currentUser', JSON.stringify(userData));
            
            // è·³è½‰åˆ°é¦–é 
            alert(`æ­¡è¿åŠ å…¥,${name}!ğŸ‰`);
            window.location.href = 'index.html';
          } else {
            showError('è¨»å†Šå¤±æ•—,è«‹ç¨å¾Œå†è©¦');
          }
        }
        
      } catch (error) {
        console.error('ç™»å…¥è™•ç†å¤±æ•—:', error);
        showError('ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
      } finally {
        document.getElementById('loadingState').classList.remove('active');
      }
    }
    
    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    window.onload = function() {
      console.log('é é¢è¼‰å…¥å®Œæˆ,åˆå§‹åŒ– Google ç™»å…¥...');
      
      // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      const currentUser = localStorage.getItem('currentUser');
      if (currentUser) {
        try {
          const user = JSON.parse(currentUser);
          if (confirm(`æ‚¨å·²ç™»å…¥ç‚º ${user.displayName},è¦ç¹¼çºŒä½¿ç”¨å—?`)) {
            window.location.href = 'index.html';
            return;
          } else {
            localStorage.removeItem('currentUser');
          }
        } catch (e) {
          localStorage.removeItem('currentUser');
        }
      }
      
      // ç­‰å¾… Google API è¼‰å…¥
      if (typeof google !== 'undefined' && google.accounts) {
        initializeGoogleLogin();
      } else {
        // å¦‚æœé‚„æ²’è¼‰å…¥,ç­‰å¾…ä¸€ä¸‹å†è©¦
        setTimeout(() => {
          if (typeof google !== 'undefined' && google.accounts) {
            initializeGoogleLogin();
          } else {
            showError('Google ç™»å…¥æœå‹™è¼‰å…¥å¤±æ•—,è«‹é‡æ–°æ•´ç†é é¢');
          }
        }, 1000);
      }
    };
    
    // åˆå§‹åŒ– Google ç™»å…¥
    function initializeGoogleLogin() {
      try {
        // åˆå§‹åŒ– Google Identity Services
        google.accounts.id.initialize({
          client_id: '337555990444-q69o7nufa9rmumi33nsggdcump0su9hb.apps.googleusercontent.com',
          callback: handleCredentialResponse,
          auto_select: false
        });
        
        // æ¸²æŸ“ç™»å…¥æŒ‰éˆ•åˆ°æ­£ç¢ºçš„å®¹å™¨
        google.accounts.id.renderButton(
          document.getElementById('google-button'),  // âœ… æ­£ç¢ºçš„æŒ‰éˆ•å®¹å™¨
          { 
            theme: 'outline', 
            size: 'large',
            text: 'signin_with',
            locale: 'zh_TW',
            width: 250
          }
        );
        
        console.log('Google ç™»å…¥æŒ‰éˆ•å·²æ¸²æŸ“');
      } catch (error) {
        console.error('åˆå§‹åŒ– Google ç™»å…¥å¤±æ•—:', error);
        showError('åˆå§‹åŒ–ç™»å…¥æœå‹™å¤±æ•—: ' + error.message);
      }
    }
  </script>
</body>
</html>